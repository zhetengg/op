name: OpenWrt Build J4125

on:
  workflow_dispatch:

env:
  CONFIG_FILE: config/x86_64.config

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      # Checkout
      - name: Checkout Repo
        uses: actions/checkout@v4

      # Free disk space
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo docker image prune -af || true
          df -h

      # Install dependencies
      - name: Prepare Environment
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential clang flex g++ gawk gcc-multilib gettext git \
            libncurses5-dev libssl-dev python3-distutils libselinux1-dev \
            libxml2-dev libcap-dev zlib1g-dev rsync unzip file wget curl python3

      # Clone OpenWrt
      - name: Clone OpenWrt Source
        run: git clone --depth=1 -b master https://github.com/coolsnowwolf/lede openwrt

      # Cache feeds
      - name: Cache OpenWrt Feeds
        uses: actions/cache@v3
        with:
          path: openwrt/feeds
          key: ${{ runner.os }}-feeds-${{ hashFiles('openwrt/feeds.conf.default') }}

      # DIY Part1 - clone OpenClash
      - name: DIY Part1
        working-directory: openwrt
        run: bash ../diy-part1.sh

      # Load config
      - name: Load Config
        working-directory: openwrt
        run: cp ../config/x86_64.config .config && make defconfig

      # Download packages
      - name: Download Packages
        working-directory: openwrt
        run: make download -j2

      # Compile
      - name: Compile OpenWrt
        working-directory: openwrt
        run: make -j2 || make -j1 V=s

      # DIY Part2 - Docker SSD 优化
      - name: DIY Part2
        working-directory: openwrt
        run: bash ../diy-part2.sh

      # Upload firmware
      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt_firmware
          path: openwrt/bin/targets
          retention-days: 30

      # Optional: cache build_dir
      - name: Cache Build Dir
        uses: actions/cache@v3
        with:
          path: openwrt/build_dir
          key: ${{ runner.os }}-build-${{ github.sha }}
