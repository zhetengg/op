name: OpenWrt Build J4125

on:
  workflow_dispatch:

env:
  CONFIG_FILE: config/x86_64.config

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 1ï¸âƒ£ Checkout ä»“åº“
      - name: Checkout Repo
        uses: actions/checkout@v4

      # 2ï¸âƒ£ é‡Šæ”¾ç£ç›˜ç©ºé—´ï¼ˆé˜²æ­¢ runner æ»¡ï¼‰
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo docker image prune -af || true
          df -h

      # 3ï¸âƒ£ å®‰è£…ä¾èµ–
      - name: Prepare Environment
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex g++ gawk gcc-multilib \
            gettext git libncurses5-dev libssl-dev python3-distutils libselinux1-dev \
            libxml2-dev libcap-dev zlib1g-dev rsync unzip file wget curl python3

      # 4ï¸âƒ£ Clone OpenWrt
      - name: Clone OpenWrt Source
        run: git clone --depth=1 -b master https://github.com/coolsnowwolf/lede openwrt

      # 5ï¸âƒ£ ç¼“å­˜ feeds
      - name: Cache OpenWrt Feeds
        uses: actions/cache@v3
        with:
          path: openwrt/feeds
          key: ${{ runner.os }}-feeds-${{ hashFiles('openwrt/feeds.conf.default') }}

      # 6ï¸âƒ£ DIY Part1 - æ’ä»¶ + ä¿®å¤ GCC13 Werror
      - name: DIY Part1
        working-directory: openwrt
        run: |
          export GIT_TERMINAL_PROMPT=0
          # OpenClash
          git clone --depth=1 https://github.com/vernesong/OpenClash package/luci-app-openclash

          # GCC13 Werror ä¿®å¤
          sed -i 's/-Werror//g' package/utils/util-linux/Makefile || true
          sed -i 's/-Werror//g' package/libs/libselinux/Makefile || true
          sed -i 's/-Werror//g' include/package.mk || true

      # 7ï¸âƒ£ å¤åˆ¶é…ç½®æ–‡ä»¶
      - name: Load Config
        working-directory: openwrt
        run: |
          cp ../config/x86_64.config .config
          make defconfig

      # 8ï¸âƒ£ ä¸‹è½½ packages
      - name: Download Packages
        working-directory: openwrt
        run: make download -j2

      # 9ï¸âƒ£ ç¼–è¯‘å›ºä»¶
      - name: Compile OpenWrt
        working-directory: openwrt
        run: make -j2 || make -j1 V=s

      # ğŸ”Ÿ DIY Part2 - Docker SSD æŒä¹…åŒ–ç›®å½•
      - name: DIY Part2
        working-directory: openwrt
        run: |
          mkdir -p /mnt/docker
          echo "Docker æ•°æ®ç›®å½• /mnt/docker å·²åˆ›å»º"

      # 11ï¸âƒ£ ä¸Šä¼ å›ºä»¶
      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt_firmware
          path: openwrt/bin/targets
          retention-days: 30

      # 12ï¸âƒ£ ç¼“å­˜ build_dir
      - name: Cache Build Dir
        uses: actions/cache@v3
        with:
          path: openwrt/build_dir
          key: ${{ runner.os }}-build-${{ github.sha }}
