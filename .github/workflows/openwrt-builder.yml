name: OpenWrt x86_64 Build

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  CONFIG_FILE: .config  # 请确保 .config 在仓库根目录
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set timezone
      run: sudo timedatectl set-timezone ${{ env.TZ }}

    - name: Prepare workdir
      run: |
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: Clone OpenWrt source
      working-directory: /workdir
      run: git clone -b ${{ env.REPO_BRANCH }} ${{ env.REPO_URL }} openwrt

    - name: Confirm .config exists
      run: |
        if [ ! -f "${{ env.CONFIG_FILE }}" ]; then
          echo ".config file not found in repository root!"
          exit 1
        fi
        echo ".config file found. First 10 lines:"
        head -n 10 ${{ env.CONFIG_FILE }}

    - name: Load config
      run: |
        cd /workdir/openwrt
        cp ${{ env.CONFIG_FILE }} .config

    - name: Update & install feeds
      run: |
        cd /workdir/openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Compile firmware
      run: |
        cd /workdir/openwrt
        make defconfig
        make -j$(nproc) V=s

    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-x86_64
        path: /workdir/openwrt/bin/targets/x86/64/
