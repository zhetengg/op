name: OpenWrt x86_64 J4125 (Stable)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # ① 极限释放空间（关键）
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
        sudo rm -rf /var/lib/apt/lists/*
        sudo docker image prune -af || true
        df -h

    # ② 依赖（最小集）
    - name: Install deps
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential clang flex gawk gcc-multilib gettext git \
          libncurses5-dev libssl-dev python3-distutils rsync unzip file wget curl

    # ③ 拉源码
    - name: Clone OpenWrt
      run: |
        git clone --depth=1 https://github.com/coolsnowwolf/lede openwrt

    # ④ OpenClash + GCC13 修复（致命点）
    - name: Prepare source
      working-directory: openwrt
      run: |
        git clone --depth=1 https://github.com/vernesong/OpenClash package/luci-app-openclash

        # 全局干掉 Werror（必须）
        sed -i 's/-Werror//g' include/package.mk
        sed -i 's/-Werror//g' package/libs/libselinux/Makefile || true
        sed -i 's/-Werror//g' package/utils/util-linux/Makefile || true

    # ⑤ 直接生成 .config（不依赖仓库）
    - name: Generate config
      working-directory: openwrt
      run: |
        cat > .config << 'EOF'
        CONFIG_TARGET_x86=y
        CONFIG_TARGET_x86_64=y
        CONFIG_TARGET_x86_64_Generic=y

        CONFIG_PACKAGE_luci=y
        CONFIG_PACKAGE_luci-theme-argon=y

        CONFIG_PACKAGE_luci-app-openclash=y
        CONFIG_PACKAGE_adguardhome=y

        CONFIG_PACKAGE_docker=y
        CONFIG_PACKAGE_dockerman=y
        CONFIG_PACKAGE_containerd=y
        CONFIG_PACKAGE_runc=y

        CONFIG_PACKAGE_luci-app-samba4=y
        CONFIG_PACKAGE_samba4-server=y

        CONFIG_PACKAGE_udpxy=y

        CONFIG_PACKAGE_kmod-fs-ext4=y
        CONFIG_PACKAGE_kmod-fs-vfat=y

        CONFIG_PACKAGE_curl=y
        CONFIG_PACKAGE_wget=y
        CONFIG_PACKAGE_vim=y
        EOF

        make defconfig

    # ⑥ 下载源码（限制并发，防爆磁盘）
    - name: Download packages
      working-directory: openwrt
      run: |
        make download -j2
        find dl -size -1024c -delete

    # ⑦ 编译：先快，失败自动降级
    - name: Compile
      working-directory: openwrt
      run: |
        make -j2 || make -j1 V=s

    # ⑧ 只上传固件（不上传整个 bin）
    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt-x86_64-J4125
        path: openwrt/bin/targets/x86/64
