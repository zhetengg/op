name: OpenWrt x86_64 Build

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  CONFIG_FILE: .config
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set timezone
      run: sudo timedatectl set-timezone ${{ env.TZ }}

    - name: Prepare workdir
      run: |
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: Clone OpenWrt source
      working-directory: /workdir
      run: git clone -b ${{ env.REPO_BRANCH }} ${{ env.REPO_URL }} openwrt

    - name: Load config
      run: |
        cp ${{ env.CONFIG_FILE }} openwrt/.config

    - name: Update & install feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Compile firmware
      run: |
        cd openwrt
        make defconfig
        make -j$(nproc) V=s

    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-x86_64
        path: openwrt/bin/targets/x86/64/
