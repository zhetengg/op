name: OpenWrt Builder

on:
  workflow_dispatch:
  repository_dispatch:

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # ================== 1. 极限清理磁盘 ==================
    - name: Free disk space (critical)
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        echo "== Before cleanup =="
        df -hT /

        sudo swapoff -a
        sudo rm -f /swapfile

        sudo rm -rf \
          /usr/share/dotnet \
          /usr/local/lib/android \
          /opt/ghc \
          /opt/hostedtoolcache \
          /usr/lib/jvm \
          /var/lib/docker

        sudo docker image prune -af
        sudo apt-get clean
        sudo apt-get autoremove -y
        sudo journalctl --vacuum-time=1d

        sudo timedatectl set-timezone "$TZ"

        echo "== After cleanup =="
        df -hT /

    # ================== 2. 准备工作目录 ==================
    - name: Prepare workdir
      run: |
        sudo mkdir -p /workdir
        sudo chown -R $USER:$USER /workdir

    # ================== 3. 克隆 OpenWrt ==================
    - name: Clone OpenWrt source
      working-directory: /workdir
      run: |
        git clone --depth=1 $REPO_URL -b $REPO_BRANCH openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    # ================== 4. 自定义 feeds ==================
    - name: Load custom feeds
      run: |
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
        chmod +x $DIY_P1_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P1_SH

    - name: Update & install feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # ================== 5. 配置 ==================
    - name: Load custom config
      run: |
        [ -e files ] && mv files openwrt/files
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
        chmod +x $DIY_P2_SH
        cd openwrt
        $GITHUB_WORKSPACE/$DIY_P2_SH

    # ================== 6. 下载依赖（限并发） ==================
    - name: Download packages
      run: |
        cd openwrt
        make defconfig
        make download -j8
        find dl -size -1024c -delete
        df -hT .

    # ================== 7. 编译（防止 OOM / 磁盘炸） ==================
    - name: Compile firmware
      id: compile
      run: |
        cd openwrt
        echo "Using $(nproc) threads"
        make -j$(nproc) || make -j1 || make -j1 V=s

    # ================== 8. 整理固件 ==================
    - name: Prepare firmware
      if: steps.compile.outcome == 'success'
      run: |
        cd openwrt
        mkdir -p firmware
        find bin/targets -type f \( -name "*.bin" -o -name "*.img.gz" \) -exec cp -v {} firmware/ \;
        echo "FIRMWARE_DATE=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

    # ================== 9. 上传 Release ==================
    - name: Upload firmware to GitHub Release
      if: steps.compile.outcome == 'success'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: OpenWrt-${{ env.FIRMWARE_DATE }}
        name: OpenWrt Firmware ${{ env.FIRMWARE_DATE }}
        body: |
          自动编译 OpenWrt 固件
          源码：${{ env.REPO_URL }}
          分支：${{ env.REPO_BRANCH }}
        files: |
          openwrt/firmware/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
