name: OpenWrt Build

on:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  CONFIG_FILE: .config          # ä»“åº“é‡Œçš„æœ€ç»ˆ .config æ–‡ä»¶
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360   # æœ€å¤§ 6 å°æ—¶ï¼Œé˜²æ­¢ç¼–è¯‘è¶…æ—¶

    steps:
    # ------------------------------
    # 1ï¸âƒ£ Checkout
    # ------------------------------
    - name: Checkout repository
      uses: actions/checkout@v3

    # ------------------------------
    # 2ï¸âƒ£ å®‰è£…ç¼–è¯‘ä¾èµ–
    # ------------------------------
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libncurses5-dev gawk git gettext libssl-dev xsltproc \
                                unzip file python3 python3-distutils gzip bc wget bzip2 patch \
                                perl perl-modules libc6-dev libelf-dev ccache time

    # ------------------------------
    # 3ï¸âƒ£ å‡†å¤‡å·¥ä½œç›®å½•ï¼ˆä½¿ç”¨ GitHub Workspaceï¼‰
    # ------------------------------
    - name: Prepare workspace
      run: |
        cd $GITHUB_WORKSPACE
        rm -rf openwrt
        git clone -b $REPO_BRANCH $REPO_URL openwrt

    # ------------------------------
    # 4ï¸âƒ£ æ·»åŠ ç¬¬ä¸‰æ–¹ feedsï¼ˆOpenClash + kenzok8ï¼‰
    # ------------------------------
    - name: Add third-party feeds
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        echo "src-git openclash https://github.com/vernesong/OpenClash.git" >> feeds.conf.default
        echo "src-git kenzok8 https://github.com/kenzok8/openwrt-packages" >> feeds.conf.default

    # ------------------------------
    # 5ï¸âƒ£ æ›´æ–°å¹¶å®‰è£… feeds
    # ------------------------------
    - name: Update and install feeds
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    # ------------------------------
    # 6ï¸âƒ£ æ”¾å…¥ä»“åº“é‡Œçš„ .config
    # ------------------------------
    - name: Copy config
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        if [ -f $GITHUB_WORKSPACE/$CONFIG_FILE ]; then
          cp $GITHUB_WORKSPACE/$CONFIG_FILE .config
        else
          echo "Error: .config not found in repo"
          exit 1
        fi

    # ------------------------------
    # 7ï¸âƒ£ ç”Ÿæˆå®Œæ•´é…ç½®
    # ------------------------------
    - name: Defconfig
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        make defconfig

    # ------------------------------
    # 8ï¸âƒ£ æ¸…ç† tmp / dlï¼Œé¿å…ç©ºé—´ä¸è¶³
    # ------------------------------
    - name: Clean download/tmp dirs
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        rm -rf tmp/* dl/*

    # ------------------------------
    # 9ï¸âƒ£ ç¼–è¯‘å›ºä»¶ï¼ˆå•çº¿ç¨‹ï¼Œç¨³å®šï¼‰
    # ------------------------------
    - name: Compile firmware
      run: |
        cd $GITHUB_WORKSPACE/openwrt
        make -j1 V=s

    # ------------------------------
    # ğŸ”Ÿ ä¸Šä¼  release
    # ------------------------------
    - name: Upload firmware to release
      if: ${{ env.UPLOAD_RELEASE == 'true' }}
      uses: softprops/action-gh-release@v1
      with:
        files: $GITHUB_WORKSPACE/openwrt/bin/targets/x86/64/*.img.gz
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
