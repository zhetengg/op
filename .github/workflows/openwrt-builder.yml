name: OpenWrt Build J4125

on:
  workflow_dispatch:

env:
  CONFIG_FILE: config/x86_64.config

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      # 1. Checkout 仓库
      - name: Checkout Repo
        uses: actions/checkout@v4

      # 2. Free Disk Space
      - name: Free Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache
          sudo docker image prune -af || true
          df -h

      # 3. 安装依赖
      - name: Prepare Environment
        run: |
          sudo apt update
          sudo apt install -y \
            build-essential clang flex g++ gawk gcc-multilib gettext git \
            libncurses5-dev libssl-dev python3-distutils libselinux1-dev \
            libxml2-dev libcap-dev zlib1g-dev rsync unzip file wget curl python3

      # 4. Clone OpenWrt 源码
      - name: Clone OpenWrt Source
        run: git clone --depth=1 -b master https://github.com/coolsnowwolf/lede openwrt

      # 5. DIY Part1 插件（只 clone OpenClash）
      - name: DIY Part1
        working-directory: openwrt
        run: bash ../diy-part1.sh

      # 6. 加载 config
      - name: Load Config
        working-directory: openwrt
        run: cp ../config/x86_64.config .config && make defconfig

      # 7. 下载包
      - name: Download Packages
        working-directory: openwrt
        run: make download -j2

      # 8. 编译
      - name: Compile OpenWrt
        working-directory: openwrt
        run: make -j2 || make -j1 V=s

      # 9. DIY Part2 - Docker SSD 优化
      - name: DIY Part2
        working-directory: openwrt
        run: bash ../diy-part2.sh

      # 10. 上传固件
      - name: Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt_firmware
          path: openwrt/bin/targets
